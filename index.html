<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Weekly I&T Progress Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- jsPDF, html2canvas and html2pdf (CDN versions) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
  <style>
    /* ========== GLOBAL RESET & BODY ========== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: "Helvetica Neue", Arial, sans-serif;
      color: #333;
      background-color: #fff; /* Clean white background for a professional PDF */
      margin: 20px;
    }

    /* ========== CONTAINER FOR PDF & MAX-WIDTH ========== */
    #pdfContainer {
      max-width: 920px;
      margin: 0 auto;
      background-color: #fff;
      padding: 20px;
      border-radius: 6px;
    }

    /* ===== PAGE BREAK RULES (for PDF generation) ===== */
    /* Avoid breaking important blocks */
    #pdfContainer h1,
    #pdfContainer h2,
    #pdfContainer p,
    #pdfContainer table,
    #pdfContainer .observations-section {
      page-break-inside: avoid;
    }

    /* ========== BUTTONS ========== */
    button {
      cursor: pointer;
      border: none;
      border-radius: 4px;
      font-size: 0.9rem;
      padding: 8px 14px;
      transition: background-color 0.2s ease, box-shadow 0.2s ease;
      margin: 0 6px 12px 0;
    }
    button:hover {
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }
    .btn-primary { background-color: #007bff; color: #fff; }
    .btn-primary:hover { background-color: #0056b3; }
    .btn-secondary { background-color: #6c757d; color: #fff; }
    .btn-secondary:hover { background-color: #495057; }
    .btn-success { background-color: #28a745; color: #fff; }
    .btn-success:hover { background-color: #218838; }

    /* ========== HEADINGS ========== */
    h1 {
      margin-top: 0.5rem;
      margin-bottom: 1rem;
      font-size: 1.8rem;
      color: #2c3e50;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    h2 {
      margin-top: 1.5rem;
      margin-bottom: 0.75rem;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #2c3e50;
      border-left: 4px solid #007bff;
      padding-left: 8px;
    }
    h3 {
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
      color: #2c3e50;
    }

    /* ========== TOP ACTIONS WRAPPER ========== */
    .top-actions {
      max-width: 920px;
      margin: 0 auto 1rem auto;
      display: flex;
      align-items: center;
      justify-content: flex-start;
    }

    /* ========== REPORT SUMMARY ========== */
    #reportSummary {
      background-color: #fefefe;
      padding: 15px;
      border: 1px solid #eee;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    #reportSummary p {
      margin-bottom: 0.5rem;
      line-height: 1.4;
    }

    /* ========== TABLES ========== */
    table {
      table-layout: auto;
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0 20px 0;
      font-size: 0.9rem;
    }
    table thead th {
      background-color: #fff;
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      vertical-align: top;
      word-wrap: break-word;
      white-space: normal;
    }
    tbody tr:nth-child(even) { background-color: #fff; }
    tr:hover td { background-color: #fff; }

    /* Over/Under color coding */
    .over-budget { color: red; font-weight: bold; }
    .under-budget { color: green; font-weight: bold; }
    .critical-def td { background-color: #ffecec; }

    /* ========== FORMS, INPUTS, MODALS ========== */
    form { margin: 0; }
    .modal {
      display: none; 
      position: fixed; 
      z-index: 999; 
      left: 0; 
      top: 0;
      width: 100%; 
      height: 100%;
      overflow: auto; 
      background-color: rgba(0,0,0,0.45);
      justify-content: center; 
      align-items: center;
      animation: fadeOut 0.3s forwards;
    }
    .modal.show {
      display: flex !important;
      animation: fadeIn 0.3s forwards;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    .modal-content {
      background-color: #fff;
      margin: auto;
      padding: 20px;
      border-radius: 6px;
      width: 400px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      animation: slideDown 0.3s;
      /* Accessibility: ARIA attributes and focus handling */
    }
    .modal-content:focus { outline: none; }
    @keyframes slideDown { from { transform: translateY(-15px); } to { transform: translateY(0); } }
    .close {
      color: #aaa;
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      margin-top: -2px;
    }
    .close:hover { color: #000; }
    .form-group { margin-bottom: 12px; }
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 4px;
    }
    input[type="text"],
    input[type="date"],
    textarea,
    select {
      width: 100%;
      padding: 6px;
      margin-bottom: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    input::placeholder, textarea::placeholder { color: #aaa; }
    .submit-btn { margin-top: 10px; font-size: 0.9rem; border-radius: 4px; padding: 8px 14px; }

    /* ========== OBSERVATIONS SECTION ========== */
    .observations-section {
      margin-bottom: 2rem;
    }
    .observations-section textarea {
      height: 60px;
      resize: vertical;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    /* (In PDF mode these textareas are temporarily replaced with divs.) */

    /* ========== HIDE .no-pdf FOR PRINT ========== */
    @media print {
      .no-pdf { display: none !important; }
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 600px) {
      body { margin: 10px; }
      #pdfContainer { padding: 10px; }
      .modal-content { width: 90% !important; }
      table, th, td { font-size: 0.8rem; }
      h2 { flex-direction: column; align-items: flex-start; }
      #dateRangeForm input[type="date"] { margin: 4px 10px 4px 0; }
    }

    /* ===== PDF MODE FINAL STYLING OVERRIDES ===== */
    #pdfContainer.pdf-mode {
      border: 1px solid #ccc;
    }
    #pdfContainer.pdf-mode h1 {
      font-size: 2rem !important;
      margin-bottom: 20px !important;
      letter-spacing: 1.5px;
    }
    #pdfContainer.pdf-mode h2 {
      font-size: 1.5rem !important;
      margin-top: 20px !important;
      margin-bottom: 10px !important;
      padding-left: 10px !important;
      border-left: 5px solid #0056b3 !important;
    }
    #pdfContainer.pdf-mode p {
      font-size: 1rem !important;
      line-height: 1.6 !important;
      margin-bottom: 10px !important;
    }
    #pdfContainer.pdf-mode table {
      margin-bottom: 20px !important;
      border-collapse: collapse !important;
    }
    #pdfContainer.pdf-mode table thead th {
      background-color: #f2f2f2 !important;
      font-weight: bold !important;
      padding: 10px !important;
      border: 1px solid #ddd !important;
    }
    #pdfContainer.pdf-mode table tbody td {
      padding: 10px !important;
      border: 1px solid #ddd !important;
    }
  </style>
</head>
<body>

  <!-- ========== TOP-LEVEL UI ELEMENTS (NOT IN PDF) ========== -->
  <div class="top-actions">
    <button class="btn-primary" onclick="downloadPDF()">Download PDF</button>
    <button class="btn-secondary" onclick="clearAllData()">Clear All Entries</button>
  </div>

  <!-- Date Range Form -->
  <form id="dateRangeForm" onsubmit="updateDateRange(event)" style="max-width: 920px; margin: 0 auto 1rem auto;">
    <label for="startDate" style="margin-right: 6px; font-weight: 600;">Start Date:</label>
    <input type="date" id="startDate" required>
    <label for="endDate" style="margin-left: 10px; margin-right: 6px; font-weight: 600;">End Date:</label>
    <input type="date" id="endDate" required>
    <button class="btn-secondary" type="submit" style="margin-top:4px;">Set Date Range</button>
  </form>

  <!-- “Add” Buttons for data entry -->
  <div style="max-width:920px; margin:0 auto 1rem auto;">
    <button class="btn-primary" onclick="openModal('completedModal', 'completedProjectNumber')">Add Completed Inspection</button>
    <button class="btn-primary" onclick="openModal('ongoingModal', 'ongoingProjectNumber')">Add Ongoing Inspection</button>
    <button class="btn-primary" onclick="openModal('deficiencyModal', 'defSiteName')">Add Deficiency / Follow-up</button>
  </div>

  <!-- ========== PDF CONTAINER (REPORTING ELEMENTS) ========== -->
  <div id="pdfContainer">
    <!-- Report Summary Section -->
    <div id="reportSummary">
      <h2>Report Summary</h2>
      <p><strong>Date Range Covered:</strong>
         <span id="dateRangeDisplay">[mm/dd/yyyy - mm/dd/yyyy]</span></p>
      <p><strong>Total Inspections Completed:</strong>
         <span id="totalCompletedCount">0</span></p>
      <p><strong>Total Hours (Bid vs. Worked):</strong>
         <span id="totalBidHours">0</span> / <span id="totalHoursWorked">0</span></p>
      <p><strong>Number of Sites with Deficiencies:</strong>
         <span id="defSiteCount">0</span></p>
      <p><strong>Open Follow-up Actions:</strong>
         <span id="openFollowupCount">0</span></p>
    </div>

    <h1>Weekly I&T Progress Report</h1>

    <!-- Completed Inspections Section -->
    <section>
      <h2>Completed Inspections</h2>
      <table id="completedTable">
        <thead>
          <tr>
            <th>Project #</th>
            <th>Site Name</th>
            <th>Date Completed</th>
            <th>Bid Hours</th>
            <th>Actual Hours</th>
            <th>Over/Under %</th>
            <th>Deficiencies (#)</th>
            <th>Notes</th>
            <th class="no-pdf">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Ongoing / In-Progress Inspections Section -->
    <section>
      <h2>Ongoing / In-Progress Inspections</h2>
      <table id="ongoingTable">
        <thead>
          <tr>
            <th>Project #</th>
            <th>Site Name</th>
            <th>Start Date</th>
            <th>Bid Hours</th>
            <th>Hours Worked</th>
            <th>Over/Under %</th>
            <th>Est. Completion</th>
            <th>Notes</th>
            <th class="no-pdf">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Deficiency Breakdown / Follow-ups -->
    <section>
      <h2>Deficiency Breakdown / Follow-ups</h2>
      <table id="deficiencyTable">
        <thead>
          <tr>
            <th>Site Name</th>
            <th>Critical? (Y/N)</th>
            <th>Next Steps</th>
            <th>Follow Up Date</th>
            <th>Assigned To</th>
            <th class="no-pdf">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Key Observations & Recommendations -->
    <section class="observations-section">
      <h2>Key Observations & Recommendations</h2>
      <div class="form-group">
        <label for="trendsNoticed">Trends Noticed:</label>
        <textarea id="trendsNoticed" placeholder="Any common findings or patterns here?"></textarea>
      </div>
      <div class="form-group">
        <label for="resourceChallenges">Resource Challenges:</label>
        <textarea id="resourceChallenges" placeholder="Equipment or personnel issues, scheduling, etc."></textarea>
      </div>
      <div class="form-group">
        <label for="suggestedImprovements">Suggested Process Improvements:</label>
        <textarea id="suggestedImprovements" placeholder="Ideas to improve efficiency or quality."></textarea>
      </div>
    </section>
  </div>
  <!-- /#pdfContainer -->

  <!-- =========================================
       MODALS FOR ADDING/EDITING
       ========================================= -->
  <!-- Completed Inspection Modal -->
  <div id="completedModal" class="modal" onclick="outsideClickClose(event, 'completedModal')">
    <div class="modal-content" role="dialog" aria-modal="true" tabindex="-1">
      <span class="close" onclick="closeModal('completedModal')">&times;</span>
      <h3>Add Completed Inspection</h3>
      <form onsubmit="addCompleted(event)">
        <div class="form-group">
          <label for="completedProjectNumber">Project Number</label>
          <input type="text" id="completedProjectNumber" placeholder="e.g. 1001A" required autofocus/>
        </div>
        <div class="form-group">
          <label for="completedSiteName">Site Name</label>
          <input type="text" id="completedSiteName" placeholder="e.g. Main St. Warehouse" required />
        </div>
        <div class="form-group">
          <label for="completedDate">Date Completed</label>
          <input type="date" id="completedDate" required />
        </div>
        <div class="form-group">
          <label for="completedBidHours">Bid Hours</label>
          <input type="text" id="completedBidHours" placeholder="e.g. 10" required />
        </div>
        <div class="form-group">
          <label for="completedActualHours">Actual Hours</label>
          <input type="text" id="completedActualHours" placeholder="e.g. 12.5" required />
        </div>
        <div class="form-group">
          <label for="completedDeficienciesFound">Deficiencies Found (#)</label>
          <input type="text" id="completedDeficienciesFound" placeholder="e.g. 2" required />
        </div>
        <div class="form-group">
          <label for="completedNotes">Notes</label>
          <textarea id="completedNotes" placeholder="e.g. Completed ahead of schedule..."></textarea>
        </div>
        <button type="submit" class="submit-btn btn-success">Add</button>
      </form>
    </div>
  </div>

  <!-- Ongoing Inspection Modal -->
  <div id="ongoingModal" class="modal" onclick="outsideClickClose(event, 'ongoingModal')">
    <div class="modal-content" role="dialog" aria-modal="true" tabindex="-1">
      <span class="close" onclick="closeModal('ongoingModal')">&times;</span>
      <h3>Add Ongoing Inspection</h3>
      <form onsubmit="addOngoing(event)">
        <div class="form-group">
          <label for="ongoingProjectNumber">Project Number</label>
          <input type="text" id="ongoingProjectNumber" placeholder="e.g. 1023B" required autofocus/>
        </div>
        <div class="form-group">
          <label for="ongoingSiteName">Site Name</label>
          <input type="text" id="ongoingSiteName" placeholder="e.g. Riverside Plant" required />
        </div>
        <div class="form-group">
          <label for="ongoingStartDate">Start Date</label>
          <input type="date" id="ongoingStartDate" required />
        </div>
        <div class="form-group">
          <label for="ongoingBidHours">Bid Hours</label>
          <input type="text" id="ongoingBidHours" placeholder="e.g. 15" required />
        </div>
        <div class="form-group">
          <label for="ongoingHoursWorked">Hours Worked So Far</label>
          <input type="text" id="ongoingHoursWorked" placeholder="e.g. 7.5" required />
        </div>
        <div class="form-group">
          <label for="ongoingEstCompletion">Estimated Completion Date</label>
          <input type="date" id="ongoingEstCompletion" required />
        </div>
        <div class="form-group">
          <label for="ongoingNotes">Notes</label>
          <textarea id="ongoingNotes" placeholder="e.g. Expect to finish early..."></textarea>
        </div>
        <button type="submit" class="submit-btn btn-success">Add</button>
      </form>
    </div>
  </div>

  <!-- Deficiency / Follow-up Modal -->
  <div id="deficiencyModal" class="modal" onclick="outsideClickClose(event, 'deficiencyModal')">
    <div class="modal-content" role="dialog" aria-modal="true" tabindex="-1">
      <span class="close" onclick="closeModal('deficiencyModal')">&times;</span>
      <h3>Add Deficiency / Follow-up</h3>
      <form onsubmit="addDeficiency(event)">
        <div class="form-group">
          <label for="defSiteName">Site Name</label>
          <input type="text" id="defSiteName" placeholder="e.g. North Dock" required autofocus/>
        </div>
        <div class="form-group">
          <label for="defIsCritical">Deficiencies Found Critical? (Y/N)</label>
          <select id="defIsCritical">
            <option value="Y">Y</option>
            <option value="N">N</option>
          </select>
        </div>
        <div class="form-group">
          <label for="defNextSteps">Next Steps</label>
          <textarea id="defNextSteps" placeholder="e.g. Order new safety signage..."></textarea>
        </div>
        <div class="form-group">
          <label for="defFollowUpDate">Follow Up Date</label>
          <input type="date" id="defFollowUpDate" />
        </div>
        <div class="form-group">
          <label for="defAssignedTo">Assigned To</label>
          <input type="text" id="defAssignedTo" placeholder="e.g. John Doe" />
        </div>
        <button type="submit" class="submit-btn btn-success">Add</button>
      </form>
    </div>
  </div>

  <!-- Edit Completed Inspection Modal -->
  <div id="editCompletedModal" class="modal" onclick="outsideClickClose(event, 'editCompletedModal')">
    <div class="modal-content" role="dialog" aria-modal="true" tabindex="-1">
      <span class="close" onclick="closeModal('editCompletedModal')">&times;</span>
      <h3>Edit Completed Inspection</h3>
      <form onsubmit="editCompleted(event)">
        <div class="form-group">
          <label for="editCompletedProjectNumber">Project Number</label>
          <input type="text" id="editCompletedProjectNumber" required />
        </div>
        <div class="form-group">
          <label for="editCompletedSiteName">Site Name</label>
          <input type="text" id="editCompletedSiteName" required />
        </div>
        <div class="form-group">
          <label for="editCompletedDate">Date Completed</label>
          <input type="date" id="editCompletedDate" required />
        </div>
        <div class="form-group">
          <label for="editCompletedBidHours">Bid Hours</label>
          <input type="text" id="editCompletedBidHours" required />
        </div>
        <div class="form-group">
          <label for="editCompletedActualHours">Actual Hours</label>
          <input type="text" id="editCompletedActualHours" required />
        </div>
        <div class="form-group">
          <label for="editCompletedDeficienciesFound">Deficiencies Found (#)</label>
          <input type="text" id="editCompletedDeficienciesFound" required />
        </div>
        <div class="form-group">
          <label for="editCompletedNotes">Notes</label>
          <textarea id="editCompletedNotes"></textarea>
        </div>
        <button type="submit" class="submit-btn btn-success">Save Changes</button>
      </form>
    </div>
  </div>

  <!-- Edit Ongoing Inspection Modal -->
  <div id="editOngoingModal" class="modal" onclick="outsideClickClose(event, 'editOngoingModal')">
    <div class="modal-content" role="dialog" aria-modal="true" tabindex="-1">
      <span class="close" onclick="closeModal('editOngoingModal')">&times;</span>
      <h3>Edit Ongoing Inspection</h3>
      <form onsubmit="editOngoing(event)">
        <div class="form-group">
          <label for="editOngoingProjectNumber">Project Number</label>
          <input type="text" id="editOngoingProjectNumber" required />
        </div>
        <div class="form-group">
          <label for="editOngoingSiteName">Site Name</label>
          <input type="text" id="editOngoingSiteName" required />
        </div>
        <div class="form-group">
          <label for="editOngoingStartDate">Start Date</label>
          <input type="date" id="editOngoingStartDate" required />
        </div>
        <div class="form-group">
          <label for="editOngoingBidHours">Bid Hours</label>
          <input type="text" id="editOngoingBidHours" required />
        </div>
        <div class="form-group">
          <label for="editOngoingHoursWorked">Hours Worked So Far</label>
          <input type="text" id="editOngoingHoursWorked" required />
        </div>
        <div class="form-group">
          <label for="editOngoingEstCompletion">Estimated Completion Date</label>
          <input type="date" id="editOngoingEstCompletion" required />
        </div>
        <div class="form-group">
          <label for="editOngoingNotes">Notes</label>
          <textarea id="editOngoingNotes"></textarea>
        </div>
        <button type="submit" class="submit-btn btn-success">Save Changes</button>
      </form>
    </div>
  </div>

  <!-- Edit Deficiency / Follow-up Modal -->
  <div id="editDeficiencyModal" class="modal" onclick="outsideClickClose(event, 'editDeficiencyModal')">
    <div class="modal-content" role="dialog" aria-modal="true" tabindex="-1">
      <span class="close" onclick="closeModal('editDeficiencyModal')">&times;</span>
      <h3>Edit Deficiency / Follow-up</h3>
      <form onsubmit="editDeficiency(event)">
        <div class="form-group">
          <label for="editDefSiteName">Site Name</label>
          <input type="text" id="editDefSiteName" required />
        </div>
        <div class="form-group">
          <label for="editDefIsCritical">Deficiencies Found Critical? (Y/N)</label>
          <select id="editDefIsCritical">
            <option value="Y">Y</option>
            <option value="N">N</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editDefNextSteps">Next Steps</label>
          <textarea id="editDefNextSteps"></textarea>
        </div>
        <div class="form-group">
          <label for="editDefFollowUpDate">Follow Up Date</label>
          <input type="date" id="editDefFollowUpDate" />
        </div>
        <div class="form-group">
          <label for="editDefAssignedTo">Assigned To</label>
          <input type="text" id="editDefAssignedTo" />
        </div>
        <button type="submit" class="submit-btn btn-success">Save Changes</button>
      </form>
    </div>
  </div>

  <script>
    // ======================
    // LOCAL STORAGE KEYS
    // ======================
    const LS_COMPLETED_KEY    = 'weekly_completed';
    const LS_ONGOING_KEY      = 'weekly_ongoing';
    const LS_DEFICIENCIES_KEY = 'weekly_deficiencies';
    const LS_NOTES_KEY        = 'weekly_notes';
    const LS_DATE_RANGE_KEY   = 'weekly_dateRange';

    // ======================
    // DATE HELPERS
    // ======================
    function parseLocalDate(dateString) {
      if (!dateString) return null;
      const [year, month, day] = dateString.split('-').map(Number);
      return new Date(year, month - 1, day);
    }
    function formatDate(dateObj) {
      if (!dateObj) return '';
      const mm = ('0' + (dateObj.getMonth() + 1)).slice(-2);
      const dd = ('0' + dateObj.getDate()).slice(-2);
      const yyyy = dateObj.getFullYear();
      return `${mm}/${dd}/${yyyy}`;
    }
    function formatDateString(dateString) {
      const d = parseLocalDate(dateString);
      return d ? formatDate(d) : '';
    }

    // ======================
    // OVER/UNDER UTILITY
    // ======================
    function calculateOverUnder(bid, actual) {
      const b = parseFloat(bid), a = parseFloat(actual);
      if (isNaN(b) || isNaN(a) || b === 0) {
        return { text: 'N/A', className: '' };
      }
      const diff = ((b - a) / b) * 100;
      const txt = diff.toFixed(2) + '%';
      if (diff > 0) {
        return { text: '+' + txt, className: 'under-budget' };
      } else if (diff < 0) {
        return { text: txt, className: 'over-budget' };
      }
      return { text: '0.00%', className: '' };
    }

    // ======================
    // UPDATE STATS & SAVE DATA
    // ======================
    function updateStats() {
      // Completed inspections
      const cRows = document.querySelectorAll('#completedTable tbody tr');
      document.getElementById('totalCompletedCount').innerText = cRows.length;
      let sumBidCompleted = 0, sumActCompleted = 0;
      cRows.forEach(row => {
        const bidH = parseFloat(row.cells[3].innerText) || 0;
        const actH = parseFloat(row.cells[4].innerText) || 0;
        sumBidCompleted += bidH;
        sumActCompleted += actH;
      });
      // Ongoing inspections
      const oRows = document.querySelectorAll('#ongoingTable tbody tr');
      let sumBidOngoing = 0, sumWorkedOngoing = 0;
      oRows.forEach(row => {
        const bidH = parseFloat(row.cells[3].innerText) || 0;
        const workedH = parseFloat(row.cells[4].innerText) || 0;
        sumBidOngoing += bidH;
        sumWorkedOngoing += workedH;
      });
      const totalBid = sumBidCompleted + sumBidOngoing;
      const totalWorked = sumActCompleted + sumWorkedOngoing;
      document.getElementById('totalBidHours').innerText = totalBid.toFixed(2);
      document.getElementById('totalHoursWorked').innerText = totalWorked.toFixed(2);
      // Deficiencies
      const dRows = document.querySelectorAll('#deficiencyTable tbody tr');
      document.getElementById('defSiteCount').innerText = dRows.length;
      document.getElementById('openFollowupCount').innerText = dRows.length;
      saveAllData();
    }

    // ======================
    // SET DATE RANGE
    // ======================
    function updateDateRange(e) {
      e.preventDefault();
      const s = document.getElementById('startDate').value;
      const en = document.getElementById('endDate').value;
      document.getElementById('dateRangeDisplay').innerText =
        `${formatDateString(s)} - ${formatDateString(en)}`;
      saveAllData();
    }

    // ======================
    // CLEAR ALL ENTRIES
    // ======================
    function clearAllData() {
      if (!confirm("Are you sure you want to clear all entries?")) return;
      document.querySelector('#completedTable tbody').innerHTML = '';
      document.querySelector('#ongoingTable tbody').innerHTML = '';
      document.querySelector('#deficiencyTable tbody').innerHTML = '';
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      document.getElementById('dateRangeDisplay').innerText = '[mm/dd/yyyy - mm/dd/yyyy]';
      document.getElementById('trendsNoticed').value = '';
      document.getElementById('resourceChallenges').value = '';
      document.getElementById('suggestedImprovements').value = '';
      updateStats();
      localStorage.clear();
    }

    // ======================
    // DOWNLOAD PDF USING html2pdf.js (handles page-breaks)
    // ======================
    async function downloadPDF() {
      // Hide non-PDF elements
      document.querySelectorAll('.no-pdf').forEach(el => el.style.display = 'none');
      
      const pdfContainer = document.getElementById('pdfContainer');
      const opt = {
        margin: 10,
        filename: 'Weekly_IT_Progress_Report.pdf',
        image: { type: 'png', quality: 1 },
        html2canvas: { scale: window.devicePixelRatio || 2, backgroundColor: '#ffffff' },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        // Using pagebreak mode to avoid splitting inside elements that have CSS page-break rules
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
      };
      
      await html2pdf().set(opt).from(pdfContainer).save();
      
      // Restore non-PDF elements
      document.querySelectorAll('.no-pdf').forEach(el => el.style.display = '');
    }

    // ======================
    // GENERIC MODAL HELPERS
    // ======================
    function openModal(modalId, focusElementId) {
      const modal = document.getElementById(modalId);
      modal.classList.add('show');
      if (focusElementId) setTimeout(() => document.getElementById(focusElementId).focus(), 150);
    }
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.remove('show');
      const form = modal.querySelector('form');
      if (form) form.reset();
    }
    function outsideClickClose(e, modalId) {
      if (e.target.id === modalId) {
        closeModal(modalId);
      }
    }
    // Close modals with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === "Escape") {
        document.querySelectorAll('.modal.show').forEach(modal => modal.classList.remove('show'));
      }
    });

    // ======================
    // EDIT MODALS: Open & Close
    // ======================
    let currentEditCompletedRow = null;
    function openEditCompleted(btn) {
      let row = btn.parentNode.parentNode;
      currentEditCompletedRow = row;
      const r = row.cells;
      document.getElementById('editCompletedProjectNumber').value = r[0].innerText;
      document.getElementById('editCompletedSiteName').value = r[1].innerText;
      document.getElementById('editCompletedDate').value = r[2].getAttribute('data-raw') || '';
      document.getElementById('editCompletedBidHours').value = r[3].innerText;
      document.getElementById('editCompletedActualHours').value = r[4].innerText;
      document.getElementById('editCompletedDeficienciesFound').value = r[6].innerText;
      document.getElementById('editCompletedNotes').value = r[7].innerText;
      openModal('editCompletedModal', 'editCompletedProjectNumber');
    }
    function openEditOngoing(btn) {
      let row = btn.parentNode.parentNode;
      currentEditOngoingRow = row;
      const r = row.cells;
      document.getElementById('editOngoingProjectNumber').value = r[0].innerText;
      document.getElementById('editOngoingSiteName').value = r[1].innerText;
      document.getElementById('editOngoingStartDate').value = r[2].getAttribute('data-raw') || '';
      document.getElementById('editOngoingBidHours').value = r[3].innerText;
      document.getElementById('editOngoingHoursWorked').value = r[4].innerText;
      document.getElementById('editOngoingEstCompletion').value = r[6].getAttribute('data-raw') || '';
      document.getElementById('editOngoingNotes').value = r[7].innerText;
      openModal('editOngoingModal', 'editOngoingProjectNumber');
    }
    let currentEditDeficiencyRow = null;
    function openEditDeficiency(btn) {
      let row = btn.parentNode.parentNode;
      currentEditDeficiencyRow = row;
      const r = row.cells;
      document.getElementById('editDefSiteName').value = r[0].innerText;
      document.getElementById('editDefIsCritical').value = r[1].innerText;
      document.getElementById('editDefNextSteps').value = r[2].innerText;
      document.getElementById('editDefFollowUpDate').value = r[3].getAttribute('data-raw') || '';
      document.getElementById('editDefAssignedTo').value = r[4].innerText;
      openModal('editDeficiencyModal', 'editDefSiteName');
    }

    // ======================
    // DELETE ROW
    // ======================
    function deleteRow(btn) {
      const row = btn.parentNode.parentNode;
      row.remove();
      updateStats();
    }

    // ======================
    // ADD: Completed Inspection
    // ======================
    function addCompleted(e) {
      e.preventDefault();
      const pn = document.getElementById('completedProjectNumber').value.trim();
      const sn = document.getElementById('completedSiteName').value.trim();
      const dt = document.getElementById('completedDate').value;
      const bh = document.getElementById('completedBidHours').value.trim();
      const ah = document.getElementById('completedActualHours').value.trim();
      const df = document.getElementById('completedDeficienciesFound').value.trim();
      const notes = document.getElementById('completedNotes').value.trim();
      const tbody = document.querySelector('#completedTable tbody');
      const row = tbody.insertRow();
      row.insertCell().innerText = pn;
      row.insertCell().innerText = sn;
      let dateC = row.insertCell();
      dateC.innerText = formatDateString(dt);
      dateC.setAttribute('data-raw', dt);
      row.insertCell().innerText = bh;
      row.insertCell().innerText = ah;
      const overUnder = calculateOverUnder(bh, ah);
      let ouCell = row.insertCell();
      ouCell.innerText = overUnder.text;
      if (overUnder.className) ouCell.classList.add(overUnder.className);
      row.insertCell().innerText = df;
      row.insertCell().innerText = notes;
      const actionsCell = row.insertCell();
      actionsCell.classList.add('no-pdf');
      actionsCell.innerHTML = `
        <button class="btn-secondary" onclick="openEditCompleted(this)">Edit</button>
        <button class="btn-secondary" onclick="deleteRow(this)">Delete</button>
      `;
      closeModal('completedModal');
      updateStats();
    }

    // ======================
    // ADD: Ongoing Inspection
    // ======================
    function addOngoing(e) {
      e.preventDefault();
      const pn = document.getElementById('ongoingProjectNumber').value.trim();
      const sn = document.getElementById('ongoingSiteName').value.trim();
      const startD = document.getElementById('ongoingStartDate').value;
      const bh = document.getElementById('ongoingBidHours').value.trim();
      const hw = document.getElementById('ongoingHoursWorked').value.trim();
      const estC = document.getElementById('ongoingEstCompletion').value;
      const notes = document.getElementById('ongoingNotes').value.trim();
      const tbody = document.querySelector('#ongoingTable tbody');
      const row = tbody.insertRow();
      row.insertCell().innerText = pn;
      row.insertCell().innerText = sn;
      let sdCell = row.insertCell();
      sdCell.innerText = formatDateString(startD);
      sdCell.setAttribute('data-raw', startD);
      row.insertCell().innerText = bh;
      row.insertCell().innerText = hw;
      const overUnder = calculateOverUnder(bh, hw);
      let ouCell = row.insertCell();
      ouCell.innerText = overUnder.text;
      if (overUnder.className) ouCell.classList.add(overUnder.className);
      let estCell = row.insertCell();
      estCell.innerText = formatDateString(estC);
      estCell.setAttribute('data-raw', estC);
      row.insertCell().innerText = notes;
      const actionsCell = row.insertCell();
      actionsCell.classList.add('no-pdf');
      actionsCell.innerHTML = `
        <button class="btn-secondary" onclick="openEditOngoing(this)">Edit</button>
        <button class="btn-secondary" onclick="deleteRow(this)">Delete</button>
      `;
      closeModal('ongoingModal');
      updateStats();
    }

    // ======================
    // ADD: Deficiency / Follow-up
    // ======================
    function addDeficiency(e) {
      e.preventDefault();
      const sn = document.getElementById('defSiteName').value.trim();
      const crit = document.getElementById('defIsCritical').value;
      const nxt = document.getElementById('defNextSteps').value.trim();
      const fud = document.getElementById('defFollowUpDate').value;
      const assigned = document.getElementById('defAssignedTo').value.trim();
      const tbody = document.querySelector('#deficiencyTable tbody');
      const row = tbody.insertRow();
      if (crit === "Y") row.classList.add('critical-def');
      row.insertCell().innerText = sn;
      row.insertCell().innerText = crit;
      row.insertCell().innerText = nxt;
      let followUpCell = row.insertCell();
      followUpCell.innerText = fud ? formatDateString(fud) : "";
      if (fud) followUpCell.setAttribute('data-raw', fud);
      row.insertCell().innerText = assigned;
      const actionsCell = row.insertCell();
      actionsCell.classList.add('no-pdf');
      actionsCell.innerHTML = `
        <button class="btn-secondary" onclick="openEditDeficiency(this)">Edit</button>
        <button class="btn-secondary" onclick="deleteRow(this)">Delete</button>
      `;
      closeModal('deficiencyModal');
      updateStats();
    }

    // ======================
    // EDIT: Completed Inspection
    // ======================
    function editCompleted(e) {
      e.preventDefault();
      if (!currentEditCompletedRow) return;
      const r = currentEditCompletedRow.cells;
      const pNum = document.getElementById('editCompletedProjectNumber').value.trim();
      const sName = document.getElementById('editCompletedSiteName').value.trim();
      const dt = document.getElementById('editCompletedDate').value;
      const bH = document.getElementById('editCompletedBidHours').value.trim();
      const aH = document.getElementById('editCompletedActualHours').value.trim();
      const def = document.getElementById('editCompletedDeficienciesFound').value.trim();
      const nts = document.getElementById('editCompletedNotes').value.trim();
      r[0].innerText = pNum;
      r[1].innerText = sName;
      r[2].innerText = formatDateString(dt);
      r[2].setAttribute('data-raw', dt);
      r[3].innerText = bH;
      r[4].innerText = aH;
      const overUnder = calculateOverUnder(bH, aH);
      r[5].innerText = overUnder.text;
      r[5].className = '';
      if (overUnder.className) r[5].classList.add(overUnder.className);
      r[6].innerText = def;
      r[7].innerText = nts;
      closeModal('editCompletedModal');
      updateStats();
    }

    // ======================
    // EDIT: Ongoing Inspection
    // ======================
    function editOngoing(e) {
      e.preventDefault();
      if (!currentEditOngoingRow) return;
      const r = currentEditOngoingRow.cells;
      const pN = document.getElementById('editOngoingProjectNumber').value.trim();
      const sN = document.getElementById('editOngoingSiteName').value.trim();
      const sd = document.getElementById('editOngoingStartDate').value;
      const bH = document.getElementById('editOngoingBidHours').value.trim();
      const wH = document.getElementById('editOngoingHoursWorked').value.trim();
      const eC = document.getElementById('editOngoingEstCompletion').value;
      const nt = document.getElementById('editOngoingNotes').value.trim();
      r[0].innerText = pN;
      r[1].innerText = sN;
      r[2].innerText = formatDateString(sd);
      r[2].setAttribute('data-raw', sd);
      r[3].innerText = bH;
      r[4].innerText = wH;
      const overUnder = calculateOverUnder(bH, wH);
      r[5].innerText = overUnder.text;
      r[5].className = '';
      if (overUnder.className) r[5].classList.add(overUnder.className);
      r[6].innerText = formatDateString(eC);
      r[6].setAttribute('data-raw', eC);
      r[7].innerText = nt;
      closeModal('editOngoingModal');
      updateStats();
    }

    // ======================
    // EDIT: Deficiency / Follow-up
    // ======================
    function editDeficiency(e) {
      e.preventDefault();
      if (!currentEditDeficiencyRow) return;
      const r = currentEditDeficiencyRow.cells;
      const siteN = document.getElementById('editDefSiteName').value.trim();
      const crit = document.getElementById('editDefIsCritical').value;
      const nxt = document.getElementById('editDefNextSteps').value.trim();
      const fDate = document.getElementById('editDefFollowUpDate').value;
      const assign = document.getElementById('editDefAssignedTo').value.trim();
      r[0].innerText = siteN;
      r[1].innerText = crit;
      r[2].innerText = nxt;
      if (fDate) {
        r[3].innerText = formatDateString(fDate);
        r[3].setAttribute('data-raw', fDate);
      } else {
        r[3].innerText = '';
        r[3].removeAttribute('data-raw');
      }
      r[4].innerText = assign;
      currentEditDeficiencyRow.classList.remove('critical-def');
      if (crit === "Y") {
        currentEditDeficiencyRow.classList.add('critical-def');
      }
      closeModal('editDeficiencyModal');
      updateStats();
    }

    // ======================
    // LOCAL STORAGE: SAVE & LOAD
    // ======================
    function saveAllData() {
      // Completed
      const completedRows = Array.from(document.querySelectorAll('#completedTable tbody tr')).map(row => {
        let cells = row.cells;
        return {
          projectNumber: cells[0].innerText,
          siteName: cells[1].innerText,
          dateRaw: cells[2].getAttribute('data-raw'),
          bidHours: cells[3].innerText,
          actualHours: cells[4].innerText,
          overUnder: cells[5].innerText,
          deficiencies: cells[6].innerText,
          notes: cells[7].innerText
        };
      });
      localStorage.setItem(LS_COMPLETED_KEY, JSON.stringify(completedRows));

      // Ongoing
      const ongoingRows = Array.from(document.querySelectorAll('#ongoingTable tbody tr')).map(row => {
        let cells = row.cells;
        return {
          projectNumber: cells[0].innerText,
          siteName: cells[1].innerText,
          startDateRaw: cells[2].getAttribute('data-raw'),
          bidHours: cells[3].innerText,
          hoursWorked: cells[4].innerText,
          overUnder: cells[5].innerText,
          estCompletionRaw: cells[6].getAttribute('data-raw'),
          notes: cells[7].innerText
        };
      });
      localStorage.setItem(LS_ONGOING_KEY, JSON.stringify(ongoingRows));

      // Deficiencies
      const defRows = Array.from(document.querySelectorAll('#deficiencyTable tbody tr')).map(row => {
        let cells = row.cells;
        return {
          siteName: cells[0].innerText,
          isCritical: cells[1].innerText,
          nextSteps: cells[2].innerText,
          followUpRaw: cells[3].getAttribute('data-raw') || '',
          assignedTo: cells[4].innerText
        };
      });
      localStorage.setItem(LS_DEFICIENCIES_KEY, JSON.stringify(defRows));

      // Observations
      const notesData = {
        trendsNoticed: document.getElementById('trendsNoticed').value,
        resourceChallenges: document.getElementById('resourceChallenges').value,
        suggestedImprovements: document.getElementById('suggestedImprovements').value
      };
      localStorage.setItem(LS_NOTES_KEY, JSON.stringify(notesData));

      // Date range
      const drData = {
        startDate: document.getElementById('startDate').value,
        endDate: document.getElementById('endDate').value
      };
      localStorage.setItem(LS_DATE_RANGE_KEY, JSON.stringify(drData));
    }

    function loadAllData() {
      // Completed
      const completedJSON = localStorage.getItem(LS_COMPLETED_KEY);
      if (completedJSON) {
        const rows = JSON.parse(completedJSON);
        const tbody = document.querySelector('#completedTable tbody');
        tbody.innerHTML = '';
        rows.forEach(item => {
          const row = tbody.insertRow();
          row.insertCell().innerText = item.projectNumber;
          row.insertCell().innerText = item.siteName;
          let dateC = row.insertCell();
          dateC.innerText = formatDateString(item.dateRaw);
          dateC.setAttribute('data-raw', item.dateRaw);
          row.insertCell().innerText = item.bidHours;
          row.insertCell().innerText = item.actualHours;
          let overUnder = calculateOverUnder(item.bidHours, item.actualHours);
          let ouCell = row.insertCell();
          ouCell.innerText = overUnder.text;
          if (overUnder.className) ouCell.classList.add(overUnder.className);
          row.insertCell().innerText = item.deficiencies;
          row.insertCell().innerText = item.notes;
          const actionsCell = row.insertCell();
          actionsCell.classList.add('no-pdf');
          actionsCell.innerHTML = `
            <button class="btn-secondary" onclick="openEditCompleted(this)">Edit</button>
            <button class="btn-secondary" onclick="deleteRow(this)">Delete</button>
          `;
        });
      }

      // Ongoing
      const ongoingJSON = localStorage.getItem(LS_ONGOING_KEY);
      if (ongoingJSON) {
        const rows = JSON.parse(ongoingJSON);
        const tbody = document.querySelector('#ongoingTable tbody');
        tbody.innerHTML = '';
        rows.forEach(item => {
          const row = tbody.insertRow();
          row.insertCell().innerText = item.projectNumber;
          row.insertCell().innerText = item.siteName;
          let sdCell = row.insertCell();
          sdCell.innerText = formatDateString(item.startDateRaw);
          sdCell.setAttribute('data-raw', item.startDateRaw);
          row.insertCell().innerText = item.bidHours;
          row.insertCell().innerText = item.hoursWorked;
          let overUnder = calculateOverUnder(item.bidHours, item.hoursWorked);
          let ouCell = row.insertCell();
          ouCell.innerText = overUnder.text;
          if (overUnder.className) ouCell.classList.add(overUnder.className);
          let estCell = row.insertCell();
          estCell.innerText = formatDateString(item.estCompletionRaw);
          estCell.setAttribute('data-raw', item.estCompletionRaw);
          row.insertCell().innerText = item.notes;
          const actionsCell = row.insertCell();
          actionsCell.classList.add('no-pdf');
          actionsCell.innerHTML = `
            <button class="btn-secondary" onclick="openEditOngoing(this)">Edit</button>
            <button class="btn-secondary" onclick="deleteRow(this)">Delete</button>
          `;
        });
      }

      // Deficiencies
      const defJSON = localStorage.getItem(LS_DEFICIENCIES_KEY);
      if (defJSON) {
        const rows = JSON.parse(defJSON);
        const tbody = document.querySelector('#deficiencyTable tbody');
        tbody.innerHTML = '';
        rows.forEach(item => {
          const row = tbody.insertRow();
          if (item.isCritical === "Y") row.classList.add('critical-def');
          row.insertCell().innerText = item.siteName;
          row.insertCell().innerText = item.isCritical;
          row.insertCell().innerText = item.nextSteps;
          let followUpCell = row.insertCell();
          followUpCell.innerText = item.followUpRaw ? formatDateString(item.followUpRaw) : '';
          if (item.followUpRaw) followUpCell.setAttribute('data-raw', item.followUpRaw);
          row.insertCell().innerText = item.assignedTo;
          const actionsCell = row.insertCell();
          actionsCell.classList.add('no-pdf');
          actionsCell.innerHTML = `
            <button class="btn-secondary" onclick="openEditDeficiency(this)">Edit</button>
            <button class="btn-secondary" onclick="deleteRow(this)">Delete</button>
          `;
        });
      }

      // Observations
      const notesJSON = localStorage.getItem(LS_NOTES_KEY);
      if (notesJSON) {
        const n = JSON.parse(notesJSON);
        document.getElementById('trendsNoticed').value = n.trendsNoticed || '';
        document.getElementById('resourceChallenges').value = n.resourceChallenges || '';
        document.getElementById('suggestedImprovements').value = n.suggestedImprovements || '';
      }

      // Date range
      const drJSON = localStorage.getItem(LS_DATE_RANGE_KEY);
      if (drJSON) {
        const dr = JSON.parse(drJSON);
        document.getElementById('startDate').value = dr.startDate || '';
        document.getElementById('endDate').value = dr.endDate || '';
        if (dr.startDate && dr.endDate) {
          document.getElementById('dateRangeDisplay').innerText =
            `${formatDateString(dr.startDate)} - ${formatDateString(dr.endDate)}`;
        }
      }
      updateStats();
    }

    // ======================
    // INIT: Load data on window load
    // ======================
    window.onload = loadAllData;
  </script>
</body>
</html>
